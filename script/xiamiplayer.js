/**
 * @name XiamiPlayer
 * @version 1.0.4
 * @create 2013.6.4
 * @lastmodified 2013.7.4
 * @description XiamiPlayer Plugin
 * @author MuFeng (http://mufeng.me)
 * @url http://mufeng.me/xiamiplayer.html
 **/
(function(h,g){var m=/[\n\t]/g,l=/\s+/,d=/^(\s|\u00A0)+/,c=/(\s|\u00A0)+$/,i=/iPhone|iPad|iPod/i,r=/MSIE\s[\d]+/,t=("createTouch"in document)||("ontouchstart"in h),q=!!navigator.userAgent.match(i),p=!!navigator.userAgent.match(r),o=!(typeof h.localStorage=="undefined"),k=[],f=function(){var z=0,y=-1,x=document.getElementsByTagName("script").length;while(z<=x&&y==-1){var A=document.getElementsByTagName("script")[z].src,y=A.indexOf("xiamiplayer.js");z++}if(A.indexOf("?")){A=A.split("?");A=A[0]}return A.replace(".js",".swf")},w=function(z){var y=0;do{y+=z.offsetLeft||0;z=z.offsetParent}while(z);return y},b=function(z){z=z||h.event;var y=0;if(t){y=z.touches.item(0).pageX}else{y=z.clientX+document.body.scrollLeft}return y},j=function(z,A){if(A&&typeof A==="string"){var C=(A||"").split(l);if(z.nodeType===1){if(!z.className){z.className=A}else{var y=" "+z.className+" ",B=z.className;for(var D=0,x=C.length;D<x;D++){if(y.indexOf(" "+C[D]+" ")<0){B+=" "+C[D]}}z.className=B.replace(d,"").replace(c,"")}}}},n=function(z,A){if((A&&typeof A==="string")||A===g){var B=(A||"").split(l);if(z.nodeType===1&&z.className){if(A){var y=(" "+z.className+" ").replace(m," ");for(var C=0,x=B.length;C<x;C++){y=y.replace(" "+B[C]+" "," ")}z.className=y.replace(d,"").replace(c,"")}else{z.className=""}}}},u=function(y,x){this.songid=x.songid;this.title=x.title;this.autoplay=x.autoplay||false;this.loop=x.loop||false;this.audio=h.Audio&&new Audio();this.audio&&k.push(this.audio);if(y.nodeType){this.element=y}if(this.songid){this.init()}};u.prototype={init:function(){this.ajax()},supportMp3:function(){return(((this.audio&&this.audio.canPlayType("audio/mpeg"))||q)&&!p)?true:false},flash:function(B){var z=this.element,E="xiami-"+this.songid+Math.floor(Math.random()*99999),C=B.src,D=this.title||(B.title+" - "+B.author),A=this.autoplay?1:0,y=this.loop?1:0,x=f();z.innerHTML='<embed id="'+E+'" src="'+x+"?url="+C+"&amp;autoplay="+A+"&amp;loop="+y+"&amp;descri="+D+'" type="application/x-shockwave-flash" wmode="transparent" allowscriptaccess="always" width="350" height="40">'},html5:function(A){var y=this.element,D="xiami-"+this.songid+Math.floor(Math.random()*99999),B=A.src,C=this.title||(A.title+" - "+A.author),z=this.autoplay?1:0,x=this.loop?1:0;y.innerHTML='<div id="'+D+'" class="audio-player"><div class="play-button"></div><div class="play-box"><div class="play-title">'+C+'</div><div class="play-data"><div class="play-prosess"><div class="play-loaded"></div><div class="play-prosess-bar"><div class="play-prosess-thumb"></div></div></div><div class="play-right"><div class="play-timer">--:--</div><div class="play-volume"></div></div></div></div></div>';this.elementid=D;this.buildPlayer(B)},audioElements:function(){var y=document.getElementById(this.elementid),x=[".play-button",".play-prosess",".play-prosess-bar",".play-loaded",".play-timer",".play-volume"];x.forEach(function(A,z){x[z]=y.querySelectorAll(A)[0]});return x},buildPlayer:function(B){var z=this,A=z.autoplay,y=z.elementid.replace("xiami","xiamiaudio"),x=z.audioElements();if(A&&!q){if(!document.getElementById(y)){z.hookEvent(B)}}else{x[0].addEventListener("click",function(){if(!document.getElementById(y)){z.hookEvent(B)}},false)}},hookEvent:function(C){var B=this,z=document.getElementById(B.elementid),y=B.elementid.replace("xiami","xiamiaudio"),x=B.audioElements(),A=o?localStorage.getItem("xiami-volume"):"undefined";A=(A!="undefined"&&A!=null)?A:6;this.audio.volume=Math.abs(A/6).toFixed(2);x[5].style.backgroundPosition="0 "+ -A*15+"px";this.audio.src=C;this.audio.id=y;z.appendChild(this.audio);this.audio.play();x[0].addEventListener("click",function(){if(B.audio.error){return}else{if(B.audio.readyState<4){B.config.autoplay&&(B.audio.autoplay^=true)}else{if(B.audio.paused){B.audio.play()}else{B.audio.pause()}}}},false);this.play();this.pause();this.ended();this.loadeddata();this.prosess();this.adjustProsess();this.adjustVolume()},play:function(){var x=this;this.audio.addEventListener("play",function(){j(x.audioElements()[0],"playing");x.singlePlayer(this)},false)},pause:function(){var x=this;this.audio.addEventListener("pause",function(){n(x.audioElements()[0],"playing")},false)},ended:function(){var x=this.loop;this.audio.addEventListener("ended",function(){this.pause();this.currentTime=0;x&&this.play()},false)},loadeddata:function(){var x=this;this.audio.addEventListener("loadeddata",function(){var y=setInterval(function(){if(x.audio.buffered.length<1){return true}x.audioElements()[3].style.width=(x.audio.buffered.end(0)/x.audio.duration)*100+"%";if(Math.floor(x.audio.buffered.end(0))>=Math.floor(x.audio.duration)){clearInterval(y)}},100)})},prosess:function(){var x=this;this.audio.addEventListener("timeupdate",function(){x.audioElements()[2].style.width=this.currentTime/this.duration*100+"%";x.audioElements()[4].innerHTML=x.formatTime(this.currentTime)},false)},adjustProsess:function(){var D=this,z=D.audioElements(),E=z[1],B=w(E),y=parseInt(document.defaultView.getComputedStyle(E,null).getPropertyValue("width")),F=z[2],A=t?"touchstart":"mousedown",x=t?"touchmove":"mousemove",G=t?"touchend":"mouseup",C=function(){var J=0,K=document.body,I=function(N){J++;if(J%2===0){return}var M=b(N),L=M-B;if(0<L&&L<y){D.audio.currentTime=Math.round(D.audio.duration*L/y);D.audio.play()}},H=function(){K.removeEventListener(x,I,false);K.removeEventListener(G,H,false)};K.addEventListener(x,I,false);K.addEventListener(G,H,false)};E.addEventListener(A,C,false);E.removeEventListener(G,C,false);E.onclick=function(J){var I=b(J),H=I-B;if(0<H&&H<y){D.audio.currentTime=Math.round(D.audio.duration*H/y);D.audio.play()}}},adjustVolume:function(){var z=this,x=z.audioElements(),y=x[5],A=w(y),B=parseInt(document.defaultView.getComputedStyle(y,null).getPropertyValue("width"));y.addEventListener("click",function(F){var E=b(F),D=E-A;if(0<D&&D<B){var C=Math.ceil(D/4);z.audio.volume=Math.abs(C/6).toFixed(2);y.style.backgroundPosition="0 "+ -C*15+"px";localStorage.setItem("xiami-volume",C)}},false)},singlePlayer:function(y){var z=k.length,x;for(x=z-1;x>=0;x--){if(k[x]!=y){k[x].pause()}}},ajax:function(){var x=this,y=x.songid,z=new Date().valueOf();new $JSONP.ajax({url:"http://www.xiami.com/web/get-songs",param:{type:0,rtype:"song",id:y,_:z},callback:{success:function(A){if(A.data[0]){x.supportMp3()?x.html5(A.data[0]):x.flash(A.data[0])}},failure:function(A){h.console&&console.log("Didn't get the data form xiami.com! Error: "+A)}}})},formatTime:function(z){if(!isFinite(z)||z<0){return"--:--"}else{var x=Math.floor(z/60),y=Math.floor(z)%60;return(x<10?"0"+x:x)+":"+(y<10?"0"+y:y)}}};if(typeof h.$JSONP=="undefined"){h.$JSONP={}}$JSONP._ajax=function(x){x=x[0]||{};this.url=x.url||"";this.type="json";this.method="GET";this.param=x.param||null;this.callback=x.callback||{};if(typeof h._$JSONP_callback=="undefined"){h._$JSONP_callback={}}this._createRequest()};$JSONP._ajax.prototype={_createRequest:function(){var A=document.getElementsByTagName("head")[0];var y=document.createElement("script");var x=this._setRandomFun();var C=this;var B="";for(var z in this.param){if(B==""){B=z+"="+this.param[z]}else{B+="&"+z+"="+this.param[z]}}y.type="text/javascript";y.charset="utf-8";if(A){A.appendChild(y)}else{document.body.appendChild(y)}h._$JSONP_callback[x.id]=function(D){C.callback.success(D);setTimeout(function(){delete h._$JSONP_callback[x.id];y.parentNode.removeChild(y)},100)};y.src=this.url+"?callback="+x.name+"&"+B},_setRandomFun:function(){var x="";do{x="$JSONP"+Math.floor(Math.random()*10000)}while(h._$JSONP_callback[x]);return{id:x,name:"window._$JSONP_callback."+x}}};h.$JSONP.ajax=function(){return new $JSONP._ajax(arguments)};h.xiamiplayer=u;var s=function(x){return Array.prototype.slice.call(x,0)},e=function(z,A){if(z.length!==g){for(var y=0,x=z.length;y<x;y++){if(A.call(z[y],y,z[y])===false){break}}}else{for(name in z){A.call(z[name],name,z[name])}}},v=function(y,z){var z=z||document;if(document.getElementsByClassName){return s(z.getElementsByClassName(y))}else{var x=[];var A=new RegExp("\\s"+y+"\\s");e(z.getElementsByTagName("*"),function(B){if(A.test(" "+this.className+" ")){x.push(this)}});return x}},a=(function(){var H=[],F,z,x,G,y,I=function(){x=true;clearInterval(F);while(G=H.shift()){G()}if(z){z.onreadystatechange=""}};return function(A){if(x){return A()}if(!H[0]){if(document.addEventListener){document.addEventListener("DOMContentLoaded",I,false)}else{if(/MSIE/i.test(navigator.userAgent)){document.write("<script id=__ie_onload defer src=//0><\/script>");z=document.getElementById("__ie_onload");z.onreadystatechange=function(){if(this.readyState=="complete"){I()}}}else{if(/WebKit/i.test(navigator.userAgent)){F=setInterval(function(){if(/loaded|complete/.test(document.readyState)){I()}},10)}else{y=h.onload;h.onload=function(){I();if(y){y()}}}}}}H.push(A)}})();a(function(){e(v("xiami-player"),function(y,z){var D=this,B=D.getAttribute("songid"),A=parseInt(D.getAttribute("autoplay")),x=parseInt(D.getAttribute("loop")),C=D.getAttribute("title");new u(D,{"songid":B,"autoplay":A,"loop":x,"title":C})})})})(window);